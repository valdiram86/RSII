<!-- (mesmo conteÃºdo que vocÃª jÃ¡ tem acima) -->
<!-- ... -->
<button onclick="consultar()">Acessar</button>
<button onclick="filtrarPorRanking()">Buscar por Faixa de Ranking</button>
<button onclick="mostrarTudo()">Mostrar Tudo</button>
<p id="mensagem"></p>

<!-- Destaques automÃ¡ticos -->
<div id="destaques">
  <p><strong>ðŸ§¨ Top 10 criptos com maior desvalorizaÃ§Ã£o combinada (7D + 30D) e maior volume:</strong></p>
</div>

<div id="painel">
  <p id="contador"></p>
  <table id="tabela" class="display nowrap"></table>
</div>

<!-- Scripts finais -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbz7mmD2UWw5Ve7h840FPAzlbyBMkgsDzup0Sx104hPTW9g14JAwFjTT6re2MQ_ygOuY/exec';
let dadosAtuais = [];

function consultar() {
  const email = document.getElementById("email").value.trim();
  if (!email) {
    document.getElementById("mensagem").textContent = "Informe o e-mail.";
    return;
  }

  const tokensFiltro = Array.from(document.querySelectorAll('.tokenFiltro'))
    .map(input => input.value.trim().toLowerCase()).filter(v => v !== "");

  const rankingMin = parseInt(document.getElementById("rankingMin").value.trim());
  const rankingMax = parseInt(document.getElementById("rankingMax").value.trim());

  fetch(`${API_URL}?email=${encodeURIComponent(email)}`)
    .then(r => r.json())
    .then(res => {
      if (!res.autorizado) {
        document.getElementById("mensagem").textContent = "Acesso negado.";
        return;
      }

      let dadosFiltrados = res.dados;

      if (tokensFiltro.length > 0) {
        dadosFiltrados = dadosFiltrados.filter(l =>
          tokensFiltro.includes((l["SÃ­mbolo"] || "").toLowerCase()) ||
          tokensFiltro.includes((l["Slug"] || "").toLowerCase())
        );
      }

      if (!isNaN(rankingMin) && !isNaN(rankingMax)) {
        dadosFiltrados = dadosFiltrados.filter(l =>
          parseInt(l["Rank"]) >= rankingMin && parseInt(l["Rank"]) <= rankingMax
        );
      }

      document.getElementById("mensagem").textContent = "";
      document.getElementById("painel").style.display = "block";

      const colunas = ["PreÃ§o", "SÃ­mbolo", "Rank", "RSI", "Link", "Var 24h (%)", "Var 7D (%)", "Var 30D (%)", "Volume"];
      dadosAtuais = dadosFiltrados.map(linha => colunas.map(coluna =>
        coluna.toLowerCase() === 'link' && typeof linha[coluna] === 'string'
          ? `<a href="${linha[coluna]}" target="_blank">ðŸ”—</a>` : linha[coluna]
      ));

      const dataHoje = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
      $('#tabela').DataTable({
        data: dadosAtuais,
        columns: colunas.map(c => ({ title: c })),
        destroy: true,
        dom: 'Bfrtip',
        buttons: [
          { extend: 'csvHtml5', title: `MatrixReversal-${dataHoje}` },
          { extend: 'excelHtml5', title: `MatrixReversal-${dataHoje}` }
        ],
        scrollX: true,
        paging: false,
        ordering: true,
        info: false
      });

      document.getElementById("contador").textContent = `Total de moedas carregadas: ${dadosAtuais.length}`;

      // ðŸ”¥ Top 10 desvalorizadas combinadas com volume alto
      let topCombinadas = dadosFiltrados
        .filter(row => {
          const var7d = parseFloat(row["Var 7D (%)"]);
          const var30d = parseFloat(row["Var 30D (%)"]);
          const volume = parseFloat(row["Volume"]);
          return !isNaN(var7d) && !isNaN(var30d) && !isNaN(volume)
            && var7d < 0 && var30d < 0 && volume > 0;
        })
        .map(row => ({
          simbolo: row["SÃ­mbolo"],
          score: Math.abs(parseFloat(row["Var 7D (%)"])) + Math.abs(parseFloat(row["Var 30D (%)"])) + (parseFloat(row["Volume"]) / 1000000)
        }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 10)
        .map(m => m.simbolo);

      const container = document.getElementById("destaques");
      for (let i = 0; i < 10; i++) {
        const campo = document.createElement("p");
        campo.innerHTML = `<strong>ðŸ§¨ Queda Combinada #${i + 1}:</strong> ${topCombinadas[i] || "-"}`;
        container.appendChild(campo);
      }

    })
    .catch(() => {
      document.getElementById("mensagem").textContent = "Erro ao consultar.";
    });
}

function filtrarPorRanking() {
  const rankingMin = parseInt(document.getElementById("rankingMin").value.trim());
  const rankingMax = parseInt(document.getElementById("rankingMax").value.trim());
  if (isNaN(rankingMin) || isNaN(rankingMax)) {
    document.getElementById("mensagem").textContent = "Informe valores vÃ¡lidos de ranking.";
    return;
  }

  const tabela = $('#tabela').DataTable();
  tabela.rows().every(function () {
    const data = this.data();
    const rank = parseInt(data[2]);
    if (rank >= rankingMin && rank <= rankingMax) {
      $(this.node()).show();
    } else {
      $(this.node()).hide();
    }
  });

  document.getElementById("mensagem").textContent = `Filtrado por ranking: ${rankingMin} a ${rankingMax}`;
}

function mostrarTudo() {
  const tabela = $('#tabela').DataTable();
  tabela.rows().every(function () {
    $(this.node()).show();
  });
  document.getElementById("mensagem").textContent = "Exibindo todas as criptomoedas.";
}
</script>
</body>
</html>
